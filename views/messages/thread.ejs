<section class="thread-page">
  <div class="thread-box">
    <div class="thread-header">
      <div class="chat-header">
        <h2><%= "@" + headerName %></h2>
      </div>
      <a href="/messages/<%= backTo %>" class="back-link">
        ← Back to <%= backTo.charAt(0).toUpperCase() + backTo.slice(1) %>
      </a>
    </div>

    <div class="chat-container">
      <div class="chat-messages" id="chatMessages">
        <% const allMessages = [originalMessage, ...replies].sort((a,b) => new Date(a.createdAt) - new Date(b.createdAt)); %>
        <% allMessages.forEach((msg) => { %>
          <div class="chat-message <%= msg.fromUserId?.toString() === user.id ? 'sent' : 'received' %>">
            <div class="message-bubble">
              <p class="message-text"><%= msg.text %></p>
              <time class="message-time">
                <%= new Date(msg.createdAt).toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'}) %>
              </time>
            </div>
          </div>
        <% }) %>
      </div>

      <% if (originalMessage.fromUserId) { %>
        <div class="reply-form">
          <form action="/messages/reply" method="post">
            <input type="hidden" name="toUserId" value="<%= originalMessage.fromUserId %>">
            <input type="hidden" name="replyTo" value="<%= originalMessage._id %>">
            <div class="input-group">
              <textarea name="text" placeholder="Type your reply..." required rows="1"></textarea>
              <button type="submit" class="send-btn"><span>➤</span></button>
            </div>
          </form>
        </div>
      <% } %>
    </div>
  </div>
</section>